name: "Log release to Notion"

on:
  pull_request:
    types: [closed]

jobs:
  notion-log:
    if: ${{ github.event.pull_request.merged }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install deps
        run: pip install notion-client

      - name: Gather PR info
        run: |
          echo "VERSION=PR #${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          # grab the full body from the GH context, then pipe in shell
          PR_BODY='${{ github.event.pull_request.body }}'
          FIRST_LINE=$(echo "$PR_BODY" | head -n1)
          echo "NOTES='$FIRST_LINE'" >> $GITHUB_ENV
          echo "REPO='${{ github.repository }}" >> $GITHUB_ENV
          echo "TESTED_ANDROID=false" >> $GITHUB_ENV
          echo "STATUS=Deploying" >> $GITHUB_ENV

      - name: Add row to Notion
        run: |
          python merge-task.py \
            "$VERSION" \
            "$NOTES" \
            "$REPO" \
            "$TESTED_ANDROID" \
            "$STATUS"
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
