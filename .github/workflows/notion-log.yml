# .github/workflows/notion-log.yml
name: Log release to Notion

on:
  pull_request:
    types: [closed]

jobs:
  notion-log:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

    steps:
      - name: Extract PR info
        run: |
          echo "VERSION=PR #${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          # First non-empty line of the PR body
          NOTES="$(printf '%s\n' "${{ github.event.pull_request.body }}" | sed '/^[[:space:]]*$/d' | head -n1)"
          echo "NOTES=$NOTES" >> $GITHUB_ENV
          echo "REPO=${{ github.repository }}" >> $GITHUB_ENV
          echo "TESTED_ANDROID=false" >> $GITHUB_ENV
          echo "STATUS=Deploying" >> $GITHUB_ENV
          
      - name: Post to Notion via curl
        run: |
          curl -sSL \
            -X POST https://api.notion.com/v1/pages \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "parent": { "database_id": "$NOTION_DATABASE_ID" },
            "properties": {
              "Version": {
                "title": [
                  { "text": { "content": "$VERSION" } }
                ]
              },
              "Notes": {
                "rich_text": [
                  { "text": { "content": "$NOTES" } }
                ]
              },
              "Date": {
                "date": {
                  "start": "${{ github.event.pull_request.merged_at }}"
                }
              },
              "Repo": {
                "rich_text": [
                  { "text": { "content": "$REPO" } }
                ]
              },
              "Tested in Android?": {
                "checkbox": $TESTED_ANDROID
              },
              "Status": {
                "status": {
                  "name": "$STATUS"
                }
              }
            }
          }
          EOF
